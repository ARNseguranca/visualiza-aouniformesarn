<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel Uniformes — Residencial Nascentes</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Font Awesome para ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --primary:#0077cc;
  --card:#eaf6ff;
  --bg:#f4f6f8;
  --muted:#666;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#222;min-height:100vh;display:flex;flex-direction:column}
header{background:#fff;padding:12px 18px;box-shadow:0 2px 6px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:5}
header img{height:44px}
header h1{font-size:18px;margin:0;color:var(--primary)}
main{
  flex:1;
  display:flex;
  gap:18px;
  padding:18px;
  max-width:1900px;
  margin:18px auto;
  width:98%;
}
nav{width:240px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
nav .user{font-weight:700;margin-bottom:10px}
nav ul{list-style:none;padding:0;margin:0}
nav li{padding:10px;border-radius:8px;cursor:pointer;color:var(--primary);font-weight:600}
nav li.active{background:var(--primary);color:#fff}
section.container{flex:1;min-height:400px;display:flex;flex-direction:column;gap:18px;overflow-y:auto}
.card{background:var(--card);padding:14px;border-radius:10px;margin-bottom:14px;display:flex;flex-direction:column;gap:12px}
.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:18px;align-items:start}
.login-wrap{max-width:480px;margin:60px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
.field{margin-bottom:12px}
label{display:block;font-weight:700;margin-bottom:6px}
input[type=text],input[type=password],select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
button{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
footer{padding:12px;text-align:center;color:var(--muted)}
.table-wrap{overflow:auto;background:#fff;padding:10px;border-radius:10px}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.small{font-size:13px;color:var(--muted)}

.card h2{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;margin:0 0 8px}
.card canvas{width:100% !important; min-height:200px; max-height:320px}
#dashCharts .card{min-height:320px}

/* Modal popup */
#modalOverlay{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:1000;
}
#modalContent{
  background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%;max-height:80%;overflow:auto;
}
#modalContent h3{margin-top:0;}
#modalContent ul{padding-left:20px;}
#modalContent button{margin-top:10px;background:#ef4444;}
@media(max-width:900px){
  main{flex-direction:column;padding:12px}
  nav{width:100%;order:2}
  section.container{order:1}
}
@media(max-width:600px){
  .grid2,#dashCharts{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header>
  <img src="logo-nascentes.jpg" alt="logo">
  <h1>Residencial Nascentes — Painel de Uniformes</h1>
</header>

<main>
  <!-- Login -->
  <div id="loginScreen" class="login-wrap" style="display:none">
    <h2>Login Admin</h2>
    <div class="field">
      <label>Usuário</label>
      <input id="loginUser" type="text">
    </div>
    <div class="field">
      <label>Senha</label>
      <input id="loginPass" type="password">
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnLogin">Entrar</button>
    </div>
    <div id="loginMessage" style="color:red;margin-top:10px"></div>
  </div>

  <!-- Sidebar -->
  <nav id="sidebar" style="display:none">
    <div class="user">Admin</div>
    <ul>
      <li id="navInicio" class="active">Início</li>
      <li id="navDash">Dashboard</li>
      <li id="navRel">Relatórios</li>
      <li id="logout" style="color:#999;margin-top:8px">Sair</li>
    </ul>
  </nav>

  <!-- Conteúdo -->
  <section class="container" id="app" style="display:none">
    
    <!-- Página Início -->
    <div id="pageInicio">
      <section class="grid2">
        <div class="card">
          <h2><i class="fas fa-tshirt text-blue-600"></i> Uniformes por Tipo</h2>
          <canvas id="chartTipoUniforme"></canvas>
        </div>
        <div class="card">
          <h2><i class="fas fa-users text-green-600"></i> Uniformes por Área</h2>
          <canvas id="chartUniformeArea"></canvas>
        </div>
        <div class="card">
          <h2><i class="fas fa-user-check text-emerald-600"></i> Colaboradores que preencheram o link</h2>
          <div id="totalPreencheram" style="font-size:2rem; font-weight:700; text-align:center; padding:40px 0;"></div>
        </div>
        <div class="card">
          <h2><i class="fas fa-chart-line text-purple-600"></i> Evolução de Entregas</h2>
          <canvas id="chartEvolucao"></canvas>
        </div>
      </section>
    </div>

    <!-- Página Dashboard -->
    <div id="pageDash" style="display:none">
      <section id="dashCharts" class="grid2"></section>
    </div>

    <!-- Página Relatórios -->
    <div id="pageRel" style="display:none">
      <!-- Filtros -->
      <div class="filters">
        <input type="text" id="filterNome" placeholder="Filtrar por nome...">
        <input type="text" id="filterArea" placeholder="Filtrar por área...">
        <select id="filterItem">
          <option value="">Filtrar por item...</option>
          <option value="Gandola">Gandola</option>
          <option value="Camisa Preta">Camisa Preta</option>
          <option value="Camisa Azul">Camisa Azul</option>
          <option value="Calça">Calça</option>
          <option value="Coturno">Coturno</option>
          <option value="Sapatênis">Sapatênis</option>
          <option value="Boné">Boné</option>
          <option value="Cinto">Cinto</option>
          <option value="Fivela">Fivela</option>
          <option value="Blusa Térmica">Blusa Térmica</option>
        </select>
        <select id="filterPossui">
          <option value="">Possui / Não Possui...</option>
          <option value="sim">Possui</option>
          <option value="nao">Não Possui</option>
        </select>
        <button id="btnExportPDF">Exportar PDF</button>
      </div>
      <div class="table-wrap">
        <table border="1" width="100%" cellspacing="0" cellpadding="4">
          <thead id="reportHead"></thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>

  </section>
</main>

<!-- Modal popup -->
<!-- Modal popup -->
<div id="modalOverlay">
  <div id="modalContent">
    <h3>Colaboradores</h3>
    <div style="margin-bottom:10px">
      <label>Filtrar por área:</label>
      <select id="modalFilterArea">
        <option value="">Todas</option>
        <option value="Segurança">Segurança</option>
        <option value="Atendente">Atendente</option>
        <option value="Recepção">Recepção</option>
        <option value="Correspondência">Correspondência</option>
      </select>
    </div>
    <ul id="modalList"></ul>
    <button onclick="document.getElementById('modalOverlay').style.display='none'">Fechar</button>
  </div>
</div>


<footer>@Residencial Nascentes 2025 - By Josué Amaral</footer>

<script>
(async ()=>{ 
  const scriptURL = "https://script.google.com/macros/s/AKfycbwYtzPaXQRNAp0esjPiukxeIq2eGfv_XlU7PVK1x_L3WMMJ7JxhGHKqdSpwGGMT2_SaGg/exec"; 
  const ADMIN_USER = "admin", ADMIN_PASS = "Nascentes2025";

  const loginScreen=document.getElementById("loginScreen");
  const sidebar=document.getElementById("sidebar");
  const app=document.getElementById("app");
  const btnLogin=document.getElementById("btnLogin");
  const loginUser=document.getElementById("loginUser");
  const loginPass=document.getElementById("loginPass");
  const loginMessage=document.getElementById("loginMessage");
  const logoutBtn=document.getElementById("logout");
  const navInicio=document.getElementById("navInicio");
  const navDash=document.getElementById("navDash");
  const navRel=document.getElementById("navRel");
  const pageInicio=document.getElementById("pageInicio");
  const pageDash=document.getElementById("pageDash");
  const pageRel=document.getElementById("pageRel");
  const reportHead=document.getElementById("reportHead");
  const reportBody=document.getElementById("reportBody");
  const btnExportPDF=document.getElementById("btnExportPDF");
  const totalPreencheramDiv=document.getElementById("totalPreencheram");

  const filterNome = document.getElementById("filterNome");
  const filterArea = document.getElementById("filterArea");
  const filterItem = document.getElementById("filterItem");
  const filterPossui = document.getElementById("filterPossui");

  let sheetData={headers:[],rows:[]};
  let groupedData={};

  function showLogin(){loginScreen.style.display="block"; sidebar.style.display="none"; app.style.display="none";}
  function showApp(){loginScreen.style.display="none"; sidebar.style.display="block"; app.style.display="block";}

  if(localStorage.getItem("nascentes_auth")==="1"){await initApp();} else {showLogin();}

  btnLogin.addEventListener("click",async ()=>{
    if(loginUser.value.toLowerCase()===ADMIN_USER && loginPass.value===ADMIN_PASS){
      localStorage.setItem("nascentes_auth","1"); loginMessage.textContent=""; await initApp();
    } else loginMessage.textContent="Usuário ou senha incorretos.";
  });
  logoutBtn.addEventListener("click",()=>{localStorage.removeItem("nascentes_auth"); location.reload();});

  navInicio.addEventListener("click",()=>{setActive(navInicio);showPage("inicio");});
  navDash.addEventListener("click",()=>{setActive(navDash);showPage("dash");});
  navRel.addEventListener("click",()=>{setActive(navRel);showPage("rel");});
  function setActive(el){[navInicio,navDash,navRel].forEach(x=>x.classList.remove("active")); el.classList.add("active");}
  function showPage(p){pageInicio.style.display=p==="inicio"?"block":"none"; pageDash.style.display=p==="dash"?"block":"none"; pageRel.style.display=p==="rel"?"block":"none";}

  async function initApp(){showApp(); await fetchData(); buildInicio(); buildDash(); buildReportTable(sheetData.rows); setupFilters();}

  async function fetchData(){
    try{
      const res=await fetch(scriptURL+"?action=getData&_="+Date.now());
      const json=await res.json();
      if(json.error) throw new Error(json.error);
      sheetData=json; sheetData.headers=sheetData.headers.map(h=>String(h||""));
    }catch(err){alert("Erro ao buscar dados: "+err.message);}
  }

  // -------- INÍCIO (gráficos principais)
  function buildInicio(){
    const tipos=["Gandola Possui","Camisa Preta Possui","Camisa Azul Possui","Calça Possui","Coturno Possui","Boné Possui","Cinto Possui"];
    const labelsTipo=["Gandola","Camisa Preta","Camisa Azul","Calça","Coturno","Boné","Cinto"];
    const countsTipo=labelsTipo.map((lbl,i)=>{
      let c=0; sheetData.rows.forEach(r=>{if(String(r[tipos[i]]||"").toLowerCase().includes("sim")) c++;});
      return c;
    });

    new Chart(document.getElementById("chartTipoUniforme"),{
      type:"doughnut",
      data:{labels:labelsTipo,datasets:[{data:countsTipo, backgroundColor:["#3b82f6","#6b7280","#1d4ed8","#10b981","#ef4444","#f59e0b","#8b5cf6"]}]},
      options:{plugins:{legend:{position:"bottom"}}}
    });

    // Uniformes por área
    const areaCounts={};
    sheetData.rows.forEach(r=>{
      const area=r["Área"]||"Sem área";
      if(!areaCounts[area]) areaCounts[area]=0;
      tipos.forEach(t=>{if(String(r[t]||"").toLowerCase().includes("sim")) areaCounts[area]++;});
    });
    new Chart(document.getElementById("chartUniformeArea"),{
      type:"bar",
      data:{labels:Object.keys(areaCounts),datasets:[{label:"Itens",data:Object.values(areaCounts),backgroundColor:"#34d399"}]},
      options:{indexAxis:"y"}
    });

    // -------- NOVO CARD: Colaboradores que preencheram o link --------
    const nomesUnicos = new Set();
    sheetData.rows.forEach(r=>{
      const nome = r["Nome"] || r["Nome completo"] || null;
      if(nome) nomesUnicos.add(nome.trim());
    });
    totalPreencheramDiv.textContent = nomesUnicos.size;

    // Evolução (contagem por mês)
    const evoCounts={};
    sheetData.rows.forEach(r=>{
      const d=r["Data"]||""; 
      if(d){
        const mes=d.substring(3,5)+"/"+d.substring(6,10);
        if(!evoCounts[mes]) evoCounts[mes]=0;
        if(tipos.some(t=>String(r[t]||"").toLowerCase().includes("sim"))) evoCounts[mes]++;
      }
    });
    new Chart(document.getElementById("chartEvolucao"),{
      type:"line",
      data:{labels:Object.keys(evoCounts), datasets:[{label:"Entregas", data:Object.values(evoCounts), borderColor:"#8b5cf6", backgroundColor:"#ddd6fe"}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  // -------- DASHBOARD (gráficos por item - colaboradores que têm / não têm)
function buildDash(){
  const dashRoot=document.getElementById("dashCharts"); 
  dashRoot.innerHTML="";

  const items=[
    {key:"Gandola Possui",label:"Gandola",icon:"fas fa-tshirt"},
    {key:"Camisa Preta Possui",label:"Camisa Preta",icon:"fas fa-shirt"},
    {key:"Camisa Azul Possui",label:"Camisa Azul",icon:"fas fa-shirt"},
    {key:"Calça Possui",label:"Calça",icon:"fas fa-person-boots"},
    {key:"Coturno Possui",label:"Coturno",icon:"fas fa-shoe-prints"},
    {key:"Sapatênis Possui",label:"Sapatênis/Sapatilhas",icon:"fas fa-sneaker"},
    {key:"Boné Possui",label:"Boné",icon:"fas fa-hat-cowboy"},
    {key:"Cinto Possui",label:"Cinto",icon:"fas fa-belt"},
    {key:"Fivela Possui",label:"Fivela",icon:"fas fa-buckle"},
    {key:"Blusa Térmica Possui",label:"Blusa Térmica",icon:"fas fa-sweater"}
  ];

  items.forEach(it=>{
    const colaboradoresSim = new Set();
    const colaboradoresNao = new Set();
    
    // Agrupando nomes únicos
    sheetData.rows.forEach(r=>{
      const nome = (r["Nome"]||r["Nome completo"]||"Sem nome").trim();
      const val = r[it.key] || "";
      if(val.toLowerCase().includes("sim")) colaboradoresSim.add(nome);
      else colaboradoresNao.add(nome);
    });

    // Garantir que o mesmo colaborador não esteja nas duas listas
    colaboradoresNao.forEach(nome=>{
      if(colaboradoresSim.has(nome)) colaboradoresNao.delete(nome);
    });

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h4><i class="${it.icon}"></i> ${it.label}</h4><canvas></canvas>`;
    dashRoot.appendChild(card);

    const ctx = card.querySelector("canvas").getContext("2d");
    new Chart(ctx,{
      type:'pie',
      data:{
        labels:["Possui","Não Possui"],
        datasets:[{
          data:[colaboradoresSim.size, colaboradoresNao.size],
          backgroundColor:['#0077cc','#ccc']
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        // Dentro do buildDash(), substitua esta parte:

onClick: function(evt, activeEls){
  if(activeEls.length > 0){
    const index = activeEls[0].index;
    const lista = index === 0 ? Array.from(colaboradoresSim) : Array.from(colaboradoresNao);

    // Atualiza lista ao mudar a área
    modalFilterArea.onchange = () => updateModalList(lista);

    // Inicializa lista e mostra modal
    updateModalList(lista);
    modal.style.display = "flex";
  }
}
      }
    });
  });
}

// -------- RELATÓRIO AGRUPADO POR ITEM (sem repetição)
function buildReportTable(rows){
  groupedData = {};

  const itensMap = {
    "Gandola": ["Gandola Possui","Gandola Quantidade","Gandola Tamanho"],
    "Camisa Preta": ["Camisa Preta Possui","Camisa Preta Quantidade","Camisa Preta Tamanho"],
    "Camisa Azul": ["Camisa Azul Possui","Camisa Azul Quantidade","Camisa Azul Tamanho"],
    "Calça": ["Calça Possui","Calça Quantidade","Calça Tamanho"],
    "Coturno": ["Coturno Possui","Coturno Quantidade","Coturno Tamanho"],
    "Sapatênis": ["Sapatênis Possui","Sapatênis Quantidade","Sapatênis Tamanho"],
    "Boné": ["Boné Possui","Boné Quantidade"],
    "Cinto": ["Cinto Possui","Cinto Quantidade"],
    "Fivela": ["Fivela Possui","Fivela Quantidade"],
    "Blusa Térmica": ["Blusa Térmica Possui","Blusa Térmica Quantidade","Blusa Térmica Tamanho"]
  };

  rows.forEach(r=>{
    const nome = (r["Nome"] || r["Nome completo"] || "Sem nome").toString().trim();
    const area = (r["Área"] || r["Area"] || "Sem área").toString().trim();

    if(!groupedData[nome]) groupedData[nome] = { area: area, itens: new Set() };

    Object.entries(itensMap).forEach(([item, cols])=>{
      let partes = [];
      cols.forEach(c=>{
        if(r[c] && String(r[c]).trim() !== ""){
          const chave = c.split(" ").slice(-1)[0]; // última palavra = Possui, Quantidade ou Tamanho
          partes.push(`${chave}: ${r[c]}`);
        }
      });
      if(partes.length>0){
        groupedData[nome].itens.add(`${item} - ${partes.join("; ")}`);
      }
    });
  });

  // Cabeçalho
  reportHead.innerHTML=`
    <tr>
      <th style='background:#f1f5f9'>#</th>
      <th style='background:#f1f5f9'>Colaborador</th>
      <th style='background:#f1f5f9'>Área</th>
      <th style='background:#f1f5f9'>Uniformes</th>
    </tr>`;

  // Corpo
  reportBody.innerHTML="";
  let count=1;
  Object.entries(groupedData).forEach(([nome,data])=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${count}</td>
                  <td>${nome}</td>
                  <td>${data.area}</td>
                  <td>${[...data.itens].join(" | ")}</td>`;
    reportBody.appendChild(tr);
    count++;
  });
}

  // -------- FILTROS DINÂMICOS
  function setupFilters(){
    function applyFilters(){
      const nomeVal = filterNome.value.toLowerCase();
      const areaVal = filterArea.value.toLowerCase();
      const itemVal = filterItem.value;
      const possuiVal = filterPossui.value;

      const filteredRows = sheetData.rows.filter(r=>{
        let ok = true;
        if(nomeVal && !(r["Nome"]||r["Nome completo"]||"").toLowerCase().includes(nomeVal)) ok=false;
        if(areaVal && !(r["Área"]||"").toLowerCase().includes(areaVal)) ok=false;
        if(itemVal){
          const possuiCol = r[`${itemVal} Possui`]||"";
          if(possuiVal==="sim" && !possuiCol.toLowerCase().includes("sim")) ok=false;
          if(possuiVal==="nao" && possuiCol.toLowerCase().includes("sim")) ok=false;
        }
        return ok;
      });
      buildReportTable(filteredRows);
    }
    [filterNome, filterArea, filterItem, filterPossui].forEach(el=>el.addEventListener("input",applyFilters));
  }

  // -------- PDF
  btnExportPDF.addEventListener("click",()=>{
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    doc.text("Relatório de Uniformes - Residencial Nascentes",14,16);
    const rowsPDF = Object.entries(groupedData).map(([nome,data])=>[nome,data.area,[...data.itens].join(", ")]);
    doc.autoTable({head:[["Colaborador","Área","Uniformes"]],body:rowsPDF,startY:24,styles:{fontSize:9,cellPadding:2}});
    doc.save("Relatorio-Uniformes.pdf");
  });

  // Declare fora do escopo da função para acesso global
const modal = document.getElementById("modalOverlay");
const modalList = document.getElementById("modalList");
const modalFilterArea = document.getElementById("modalFilterArea");

// Função para atualizar a lista do modal SEM REPETIÇÃO e com filtro de área
function updateModalList(lista) {
  const areaVal = normalizaTexto(modalFilterArea.value);
  modalList.innerHTML = "";

  const nomesExibir = new Set();

  lista.forEach(nome => {
    const row = sheetData.rows.find(r => normalizaTexto(r["Nome"]||r["Nome completo"]) === normalizaTexto(nome));
    if (row) {
      const area = normalizaTexto(row["Área"]||"Sem área");
      if (!areaVal || area === areaVal) {
        const nomeExibicao = (row["Nome"]||row["Nome completo"]).trim();
        if (!nomesExibir.has(nomeExibicao)) {
          nomesExibir.add(nomeExibicao);
          const li = document.createElement("li");
          li.textContent = nomeExibicao + " (" + (row["Área"]||"Sem área") + ")";
          modalList.appendChild(li);
        }
      }
    }
  });

  if (modalList.children.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Nenhum colaborador encontrado.";
    modalList.appendChild(li);
  }
}

// Função para normalizar texto (remover acentos, espaços e converter para minúsculas)
function normalizaTexto(txt) {
  return String(txt || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // Remove acentos
    .trim()
    .toLowerCase();
}

})();
</script>
</body>
</html>
