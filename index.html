<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel Uniformes — Residencial Nascentes</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF + autoTable para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --primary:#0077cc;
  --card:#eaf6ff;
  --bg:#f4f6f8;
  --muted:#666;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#222;min-height:100vh;display:flex;flex-direction:column}
header{background:#fff;padding:12px 18px;box-shadow:0 2px 6px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:5}
header img{height:44px}
header h1{font-size:18px;margin:0;color:var(--primary)}
main{flex:1;display:flex;gap:18px;padding:18px;max-width:1200px;margin:18px auto;width:100%}
nav{width:220px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
nav .user{font-weight:700;margin-bottom:10px}
nav ul{list-style:none;padding:0;margin:0}
nav li{padding:10px;border-radius:8px;cursor:pointer;color:var(--primary);font-weight:600}
nav li.active{background:var(--primary);color:#fff}
section.container{flex:1;min-height:400px;display:flex;flex-direction:column;gap:18px;overflow-y:auto}
.card{background:var(--card);padding:14px;border-radius:10px;margin-bottom:14px;display:flex;flex-direction:column;gap:12px}
.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;align-items:start}
.login-wrap{max-width:480px;margin:60px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
.field{margin-bottom:12px}
label{display:block;font-weight:700;margin-bottom:6px}
input[type=text],input[type=password],select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
button{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
footer{padding:12px;text-align:center;color:var(--muted)}
.table-wrap{overflow:auto;background:#fff;padding:10px;border-radius:10px}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.small{font-size:13px;color:var(--muted)}

/* ======= AJUSTES PROPORCIONAIS ======= */
.card canvas{width:100% !important; min-height:180px; max-height:300px}
#dashCharts .card{min-height:300px}
@media(max-width:900px){main{flex-direction:column;padding:12px}nav{width:100%;order:2}section.container{order:1}}
@media(max-width:600px){.grid2,#dashCharts{grid-template-columns:1fr}.card canvas{min-height:200px}}
</style>
</head>
<body>

<header>
  <img src="logo-nascentes.jpg" alt="logo">
  <h1>Residencial Nascentes — Painel de Uniformes</h1>
</header>

<main>
  <!-- Login screen -->
  <div id="loginScreen" class="login-wrap" style="display:none">
    <h2>Login Admin</h2>
    <div class="field">
      <label>Usuário</label>
      <input id="loginUser" type="text" value="">
    </div>
    <div class="field">
      <label>Senha</label>
      <input id="loginPass" type="password" value="">
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnLogin">Entrar</button>
      <div class="small"></b></div>
    </div>
    <div id="loginMessage" style="color:red;margin-top:10px"></div>
  </div>

  <!-- App layout -->
  <nav id="sidebar" style="display:none">
    <div class="user">Admin</div>
    <ul>
      <li id="navInicio" class="active">Início</li>
      <li id="navDash">Dashboard</li>
      <li id="navRel">Relatórios</li>
      <li id="logout" style="color:#999;margin-top:8px">Sair</li>
    </ul>
  </nav>

  <section class="container" id="app" style="display:none">
    <!-- INICIO -->
    <div id="pageInicio">
      <div class="card">
        <h3>Resumo geral</h3>
        <div class="grid2">
          <div class="card">
            <h4>Itens por Área</h4>
            <canvas id="chartByArea"></canvas>
          </div>
          <div class="card">
            <h4>Preenchimentos (Total)</h4>
            <canvas id="chartCount"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="pageDash" style="display:none">
      <div class="card">
        <h3>Dashboard detalhado</h3>
        <div class="grid2" id="dashCharts"></div>
      </div>
    </div>

    <!-- RELATORIO -->
    <div id="pageRel" style="display:none">
      <div class="card">
        <h3>Relatórios & Export</h3>
        <div class="filters">
          <select id="filterItem">
            <option value="">Filtrar por item (todos)</option>
            <option value="Camisa Preta">Camisa Preta</option>
            <option value="Camisa Azul">Camisa Azul</option>
            <option value="Gandola">Gandola</option>
            <option value="Calça">Calça</option>
            <option value="Coturno">Coturno</option>
            <option value="Sapatenis/Sapatilhas">Sapatenis/Sapatilhas</option>
            <option value="Boné">Boné</option>
            <option value="Cinto">Cinto</option>
            <option value="Fivela">Fivela</option>
            <option value="Blusa Térmica/Casaco">Blusa Térmica/Casaco</option>
          </select>

          <select id="filterHas">
            <option value="">Todos (tem / não tem)</option>
            <option value="Sim">Possui (Sim)</option>
            <option value="Não">Não possui</option>
          </select>

          <input id="filterSize" placeholder="Tamanho (ex: M, 38)">

          <button id="btnApply">Aplicar</button>
          <button id="btnExportPDF">Exportar PDF</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="reportTable" border="1" cellpadding="6" cellspacing="0" style="width:100%;border-collapse:collapse">
            <thead id="reportHead"></thead>
            <tbody id="reportBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>
</main>

<footer>@Residencial Nascentes 2025 - ByJosué Amaral</footer>

<script>
(async ()=>{
  const scriptURL = "https://script.google.com/macros/s/AKfycbwYtzPaXQRNAp0esjPiukxeIq2eGfv_XlU7PVK1x_L3WMMJ7JxhGHKqdSpwGGMT2_SaGg/exec"; 

  const ADMIN_USER = "admin";
  const ADMIN_PASS = "Nascentes2025";

  const loginScreen = document.getElementById("loginScreen");
  const sidebar = document.getElementById("sidebar");
  const app = document.getElementById("app");
  const btnLogin = document.getElementById("btnLogin");
  const loginUser = document.getElementById("loginUser");
  const loginPass = document.getElementById("loginPass");
  const loginMessage = document.getElementById("loginMessage");
  const logoutBtn = document.getElementById("logout");

  const navInicio = document.getElementById("navInicio");
  const navDash = document.getElementById("navDash");
  const navRel = document.getElementById("navRel");
  const pageInicio = document.getElementById("pageInicio");
  const pageDash = document.getElementById("pageDash");
  const pageRel = document.getElementById("pageRel");

  const filterItem = document.getElementById("filterItem");
  const filterHas = document.getElementById("filterHas");
  const filterSize = document.getElementById("filterSize");
  const btnApply = document.getElementById("btnApply");
  const btnExportPDF = document.getElementById("btnExportPDF");
  const reportHead = document.getElementById("reportHead");
  const reportBody = document.getElementById("reportBody");

  let chartByArea=null, chartCount=null;
  let sheetData={headers:[],rows:[]};

  function showLogin(){ loginScreen.style.display="block"; sidebar.style.display="none"; app.style.display="none"; }
  function showApp(){ loginScreen.style.display="none"; sidebar.style.display="block"; app.style.display="block"; }

  if(localStorage.getItem("nascentes_auth")==="1"){ await initApp(); }else{ showLogin(); }

  btnLogin.addEventListener("click",async ()=>{
    const u=(loginUser.value||"").trim();
    const p=(loginPass.value||"").trim();
    if(u.toLowerCase()===ADMIN_USER && p===ADMIN_PASS){ localStorage.setItem("nascentes_auth","1"); loginMessage.textContent=""; await initApp(); }
    else loginMessage.textContent="Usuário ou senha incorretos.";
  });

  logoutBtn.addEventListener("click",()=>{ localStorage.removeItem("nascentes_auth"); location.reload(); });

  navInicio.addEventListener("click",()=>{ setActive(navInicio); showPage("inicio"); });
  navDash.addEventListener("click",()=>{ setActive(navDash); showPage("dash"); });
  navRel.addEventListener("click",()=>{ setActive(navRel); showPage("rel"); });

  function setActive(el){ [navInicio,navDash,navRel].forEach(x=>x.classList.remove("active")); el.classList.add("active"); }
  function showPage(p){ pageInicio.style.display=p==="inicio"?"block":"none"; pageDash.style.display=p==="dash"?"block":"none"; pageRel.style.display=p==="rel"?"block":"none"; }

  async function initApp(){ showApp(); await fetchData(); buildInicio(); buildDash(); buildReportTable(sheetData.rows); }

  async function fetchData(){
    try{
      const res=await fetch(scriptURL+"?action=getData&_="+Date.now());
      const json=await res.json();
      if(json.error) throw new Error(json.error);
      sheetData=json; sheetData.headers=sheetData.headers.map(h=>String(h||""));
    }catch(err){ alert("Erro ao buscar dados: "+err.message); console.error(err);}
  }

  function buildInicio(){
    const totalFilled=sheetData.rows.filter(r=>(r["Nome"]||r["Nome completo"]||r["Nome"])).length;
    const byArea={};
    sheetData.rows.forEach(r=>{
      const area=r["Área"]||r["Area"]||"Sem área";
      if(!byArea[area]) byArea[area]=0;
      const nome=r["Nome"]||r["Nome completo"]||r["Nome"];
      if(nome && nome.toString().trim()!=="") byArea[area]++;
    });

    const ctx1=document.getElementById("chartByArea").getContext("2d");
    if(chartByArea) chartByArea.destroy();
    chartByArea=new Chart(ctx1,{type:'bar',data:{labels:Object.keys(byArea),datasets:[{label:'Respostas por área',data:Object.values(byArea),backgroundColor:'#0077cc'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});

    const ctx2=document.getElementById("chartCount").getContext("2d");
    if(chartCount) chartCount.destroy();
    chartCount=new Chart(ctx2,{type:'doughnut',data:{labels:['Preenchidos','Vazios'],datasets:[{data:[totalFilled,Math.max(0,sheetData.rows.length-totalFilled)],backgroundColor:['#0077cc','#ccc']}]},options:{responsive:true,maintainAspectRatio:false}});
  }

  function buildDash(){
    const dashRoot=document.getElementById("dashCharts");
    dashRoot.innerHTML="";

    const items=[
      {keyPossui:"Gandola Possui",label:"Gandola"},
      {keyPossui:"Camisa Preta Possui",label:"Camisa Preta"},
      {keyPossui:"Camisa Azul Possui",label:"Camisa Azul"},
      {keyPossui:"Calça Possui",label:"Calça"},
      {keyPossui:"Coturno Possui",label:"Coturno"},
      {keyPossui:"Sapatênis Possui",label:"Sapatenis/Sapatilhas"},
      {keyPossui:"Boné Possui",label:"Boné"},
      {keyPossui:"Cinto Possui",label:"Cinto"},
      {keyPossui:"Fivela Possui",label:"Fivela"},
      {keyPossui:"Blusa Térmica Possui",label:"Blusa Térmica"}
    ];

    items.forEach(item=>{
      let sim=0,nao=0,total=0;
      sheetData.rows.forEach(r=>{
        const v=r[item.keyPossui];
        if(v!==undefined && v!==null && String(v).trim()!==""){ total++; if(String(v).toLowerCase().indexOf("sim")>=0) sim++; else nao++; }
      });

      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<h4>${item.label} — ${total} respostas</h4><canvas></canvas>`;
      dashRoot.appendChild(card);
      const ctx=card.querySelector("canvas").getContext("2d");
      new Chart(ctx,{type:'pie',data:{labels:["Sim","Não"],datasets:[{data:[sim,nao],backgroundColor:['#0077cc','#ccc']}]},options:{responsive:true,maintainAspectRatio:false}});
    });
  }

  function buildReportTable(rows){
    const headers=["Nome","Área","Gandola Possui","Gandola Tamanho","Camisa Preta Possui","Camisa Preta Tamanho","Camisa Azul Possui","Camisa Azul Tamanho","Calça Possui","Calça Tamanho","Coturno Possui","Coturno Tamanho","Sapatênis Possui","Sapatênis Tamanho","Boné Possui","Boné Quantidade","Cinto Possui","Cinto Quantidade","Fivela Possui","Fivela Quantidade","Blusa Térmica Possui","Blusa Térmica Tamanho"];
    reportHead.innerHTML="<tr>"+headers.map(h=>`<th style='background:#f1f5f9'>${h}</th>`).join("")+"</tr>";

    reportBody.innerHTML="";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      const cells=headers.map(h=>r[h]!==undefined?r[h]:(r[h.replace("ã","a")]!==undefined?r[h.replace("ã","a")]: ""));
      tr.innerHTML=cells.map(c=>`<td>${c||""}</td>`).join("");
      reportBody.appendChild(tr);
    });
  }

  btnApply.addEventListener("click",()=>{
    const itemFilter=filterItem.value;
    const hasFilter=filterHas.value;
    const sizeFilter=(filterSize.value||"").trim().toLowerCase();

    const filtered=sheetData.rows.filter(r=>{
      if(!itemFilter) return true;
      const mapping={"Camisa Preta":"Camisa Preta Possui","Camisa Azul":"Camisa Azul Possui","Gandola":"Gandola Possui","Calça":"Calça Possui","Coturno":"Coturno Possui","Sapatenis/Sapatilhas":"Sapatênis Possui","Boné":"Boné Possui","Cinto":"Cinto Possui","Fivela":"Fivela Possui","Blusa Térmica/Casaco":"Blusa Térmica Possui"};
      const keyPossui=mapping[itemFilter]; if(!keyPossui) return true;
      const valPossui=(r[keyPossui]||"").toString().trim();
      if(hasFilter==="Sim" && valPossui.toLowerCase()!=="sim") return false;
      if(hasFilter==="Não" && valPossui.toLowerCase()!=="não") return false;
      if(sizeFilter){
        const tKey=keyPossui.replace("Possui","Tamanho");
        const sizeVal=(r[tKey]||"").toString().trim().toLowerCase();
        if(!sizeVal.includes(sizeFilter)) return false;
      }
      return true;
    });

    buildReportTable(filtered);
    setActive(navRel); showPage("rel");
  });

  btnExportPDF.addEventListener("click",async ()=>{
    try{
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF('l','pt','a4');
      doc.setFontSize(14);
      doc.text("Relatório de Uniformes — Residencial Nascentes",40,40);
      const headers=Array.from(reportHead.querySelectorAll("th")).map(th=>th.textContent);
      const body=Array.from(reportBody.querySelectorAll("tr")).map(tr=>Array.from(tr.children).map(td=>td.textContent));
      doc.autoTable({head:[headers],body:body,startY:70,styles:{fontSize:9},headStyles:{fillColor:[0,119,204]}});
      doc.save("Relatorio_Uniformes.pdf");
    }catch(err){ alert("Erro ao gerar PDF: "+err.message); }
  });

})();
</script>
</body>
</html>
